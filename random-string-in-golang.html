
<!DOCTYPE html>
<html lang="zh_cn.utf-8">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">


    <link rel="stylesheet" type="text/css" href="https://yull.in/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://yull.in/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://yull.in/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://yull.in/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://yull.in/theme/font-awesome/css/solid.css">

    <link href="https://yull.in/static/custom.css" rel="stylesheet">

    <link href="https://yull.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Yullin's Blog Atom">


    <link rel="shortcut icon" href="https://yull.in/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://yull.in/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-126720130-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="Yullin" />
<meta name="description" content="在学习golang的过程中，有注意到对于随机字符串的生成方式有很多种，下面就网上的罗列一下，最后一种是我最喜欢的方式，够优雅。 第一种 通用方案 最普通方案就是随机产生每个字符，所以整体字符串也是随机的。这样的好处是可以控制要使用的字符。 func init() { rand.Seed(time.Now().UnixNano()) } var letterRunes = []rune(&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;) func RandStringRunes(n int) string { b := make([]rune, n) for i := range b { b[i] = letterRuens[rand.Intn(len(letterRunes))] } return string(b) } 第二种 字节替换rune 如果需求是只使用英语字母字符(包括大小写)，那么我们可以使用byte替换rune,因为UTF-8编码中英语字母和byte是一一对应的 …" />
<meta name="keywords" content="golang, random string">

<meta property="og:site_name" content="Yullin's Blog"/>
<meta property="og:title" content="random string in golang"/>
<meta property="og:description" content="在学习golang的过程中，有注意到对于随机字符串的生成方式有很多种，下面就网上的罗列一下，最后一种是我最喜欢的方式，够优雅。 第一种 通用方案 最普通方案就是随机产生每个字符，所以整体字符串也是随机的。这样的好处是可以控制要使用的字符。 func init() { rand.Seed(time.Now().UnixNano()) } var letterRunes = []rune(&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;) func RandStringRunes(n int) string { b := make([]rune, n) for i := range b { b[i] = letterRuens[rand.Intn(len(letterRunes))] } return string(b) } 第二种 字节替换rune 如果需求是只使用英语字母字符(包括大小写)，那么我们可以使用byte替换rune,因为UTF-8编码中英语字母和byte是一一对应的 …"/>
<meta property="og:locale" content="zh_CN.UTF-8"/>
<meta property="og:url" content="https://yull.in/random-string-in-golang.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-02-07 15:20:00+08:00"/>
<meta property="article:modified_time" content="2021-02-07 15:20:00+08:00"/>
<meta property="article:author" content="https://yull.in/author/yullin.html">
<meta property="article:section" content="TECH SKILLS"/>
<meta property="article:tag" content="golang"/>
<meta property="article:tag" content="random string"/>
<meta property="og:image" content="https://yull.in/images/profile.png">

  <title>Yullin's Blog &ndash; random string in golang</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-7268840106840339",
      enable_page_level_ads: true
    });
  </script>
</head>
<body>


  <aside>
    <div>
      <a href="https://yull.in">
        <img src="https://yull.in/images/profile.png" alt="Yullin" title="Yullin">
      </a>
      <h1><a href="https://yull.in">Yullin</a></h1>

<p>Ops DevOps</p>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/Yullin" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-python" href="http://python.org/" target="_blank">
            <i class="fab fa-python">
            </i>
          </a></li>
          <li>
            <a  class="sc-Jinja2" href="http://jinja.pocoo.org/" target="_blank">
            <i class="fab fa-Jinja2">
            </i>
          </a></li>
      </ul>
    </div>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle ads-aside"
           data-ad-client="ca-pub-7268840106840339"
           data-ad-slot="8751190709"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>

  </aside>
  <main>

    <nav>
      <a href="https://yull.in">主页</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://yull.in/feeds/all.atom.xml">Atom订阅</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="random-string-in-golang">random string in golang</h1>
    <p>
      在 日 07 二月 2021 发布于 <a href="https://yull.in/category/tech-skills.html">TECH SKILLS</a> 分类

        &#8226; 3 min read
    </p>
  </header>


  <div>
    <p>在学习golang的过程中，有注意到对于随机字符串的生成方式有很多种，下面就网上的罗列一下，最后一种是我最喜欢的方式，够优雅。</p>
<h3>第一种 通用方案</h3>
<p>最普通方案就是随机产生每个字符，所以整体字符串也是随机的。这样的好处是可以控制要使用的字符。</p>
<div class="highlight"><pre><span></span>func init() {
    rand.Seed(time.Now().UnixNano())
}

var letterRunes = []rune(&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;)

func RandStringRunes(n int) string {
    b := make([]rune, n)
    for i := range b {
        b[i] = letterRuens[rand.Intn(len(letterRunes))]
    }
    return string(b)
}
</pre></div>


<h3>第二种 字节替换rune</h3>
<p>如果需求是只使用英语字母字符(包括大小写)，那么我们可以使用byte替换rune,因为UTF-8编码中英语字母和byte是一一对应的。</p>
<div class="highlight"><pre><span></span>const = letterBytes = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;

func RandStringBytes(n int) string {
    b := make([]byte, n)
    for i := rang b {
        b[i] = letterBytes[rand.Intn(len(letterBytes))]
    }
    return string(b)
}
</pre></div>


<h3>第三种 使用余数</h3>
<p>上一步种我们使用<code>rand.Intn</code>来随机选择一个字符，<code>rand.Intn</code>会调用<code>Rand.Intn</code>,而<code>Rand.Intn</code>会调用<code>Rand.Int31n</code>,它会比直接调用<code>rand.Int63</code>慢，后者会产生一个63bit的随机整数。我们可以使用rand.Int63,然后除以<code>len(letterBytes)</code>的余数来选择字符：</p>
<div class="highlight"><pre><span></span>func RandStringBytesRmndr(n int) string {
    b := make([]byte, n)
    for i := rang b {
        b[i] = letterBytes[rand.Int63() &amp; int64(len(letterBytes))]
    }
    return string(b)
}
</pre></div>


<h3>使用掩码</h3>
<p>通过前面的方案，我们可以看到我们并不需要太多的bit来决定字符的平均分布，事实上我们只需要随机整数的后几个bit就可以来选择字母。对于52个英语字母(大小写)， 只需要6个bit就可以实现均匀分布(52=110100b)，所以我们可以使用rand.Int63后6个bit来实现，我们只接受后六位在0..len(letterBytes)-1的随机数，如果不在这个范围，丢弃重选。 通过掩码就可以得到一个整数的后6个bit。</p>
<div class="highlight"><pre><span></span>const letterBytes = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;
const (
    letterIdxBits = 6                    // 6 bits to represent a letter index
    letterIdxMask = 1&lt;&lt;letterIdxBits - 1 // All 1-bits, as many as letterIdxBits
)
func RandStringBytesMask(n int) string {
    b := make([]byte, n)
    for i := 0; i &lt; n; {
        if idx := int(rand.Int63() &amp; letterIdxMask); idx &lt; len(letterBytes) {
            b[i] = letterBytes[idx]
            i++
        }
    }
    return string(b)
}
</pre></div>


<h3>掩码加强版</h3>
<p>上面有个不好的地方，会产生大量的丢弃的case,造成重选和浪费。rand.Int63会产生63bit的随机数，如果我们把它分成6份，那么一次就可以产生10个6bit的随机数。这样就减少了浪费。</p>
<div class="highlight"><pre><span></span>const letterBytes = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;
const (
    letterIdxBits = 6                    // 6 bits to represent a letter index
    letterIdxMask = 1&lt;&lt;letterIdxBits - 1 // All 1-bits, as many as letterIdxBits
    letterIdxMax  = 63 / letterIdxBits   // # of letter indices fitting in 63 bits
)
func RandStringBytesMaskImpr(n int) string {
    b := make([]byte, n)
    // A rand.Int63() generates 63 random bits, enough for letterIdxMax letters!
    for i, cache, remain := n-1, rand.Int63(), letterIdxMax; i &gt;= 0; {
        if remain == 0 {
            cache, remain = rand.Int63(), letterIdxMax
        }
        if idx := int(cache &amp; letterIdxMask); idx &lt; len(letterBytes) {
            b[i] = letterBytes[idx]
            i--
        }
        cache &gt;&gt;= letterIdxBits
        remain--
    }
    return string(b)
}
</pre></div>


<h3>Source</h3>
<p>上面的代码的确好，没有太多可以改进的地方，即使可以提升，也得花费很大的复杂度。</p>
<p>我们可以从另外一个方面进行优化，那就是提高随机数的产生(source)。</p>
<p>crypto/rand包提供了Read(b []byte)的方法，它可以随机生成我们所需bit的字节，但是因为处于安全方面的设计和检查，它的随机数产生比较慢。</p>
<p>我们再转回math/rand，rand.Rand使用rand.Source来产生随机bit。rand.Source是一个接口，提供了Int63() int64,正是我们所需要的。</p>
<p>所以我们可以直接使用rand.Source，而不是全局或者共享的随机源。</p>
<div class="highlight"><pre><span></span>var src = rand.NewSource(time.Now().UnixNano())
func RandStringBytesMaskImprSrc(n int) string {
    b := make([]byte, n)
    // A src.Int63() generates 63 random bits, enough for letterIdxMax characters!
    for i, cache, remain := n-1, src.Int63(), letterIdxMax; i &gt;= 0; {
        if remain == 0 {
            cache, remain = src.Int63(), letterIdxMax
        }
        if idx := int(cache &amp; letterIdxMask); idx &lt; len(letterBytes) {
            b[i] = letterBytes[idx]
            i--
        }
        cache &gt;&gt;= letterIdxBits
        remain--
    }
    return string(b)
}
</pre></div>


<p>全局的(默认的)随机源是线程安全，里面用到了锁，所以没有我们直接rand.Source更好。</p>
<p>下面的代码是全局的随机源，可以看到Lock/Unlock的使用。</p>
<div class="highlight"><pre><span></span>func Int63() int64 { return globalRand.Int63() }
var globalRand = New(&amp;lockedSource{src: NewSource(1).(Source64)})
type lockedSource struct {
    lk  sync.Mutex
    src Source64
}
func (r *lockedSource) Int63() (n int64) {
    r.lk.Lock()
    n = r.src.Int63()
    r.lk.Unlock()
    return
}
</pre></div>


<p>Go1.7中增加了rand.Read()方法和Rand.Read()函数，我们可以尝试使用它得到一组随机bit,用来获取更高的性能。</p>
<p>一个小问题就是取多少字节的随机数比较好？我们可以说: 和输出字符一样多的。这是一个上限估计，因为字符的索引会少于8bit。
为了维护字符的均匀分布，我们不得不丢弃一些随机数，这可能会获取更多的随机数，所以只能预估大约需要n * letterIdxBits / 8.0字节的随机byte。</p>
<p>当然最好的验证方法就是写一个Benchmark,附录是benchmark的代码，以下是测试的结果:</p>
<div class="highlight"><pre><span></span>BenchmarkRunes                   1000000              1703 ns/op
BenchmarkBytes                   1000000              1328 ns/op
BenchmarkBytesRmndr              1000000              1012 ns/op
BenchmarkBytesMask               1000000              1214 ns/op
BenchmarkBytesMaskImpr           5000000               395 ns/op
BenchmarkBytesMaskImprSrc        5000000               303 ns/op
</pre></div>


<h3>Benchmark代码</h3>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">main</span>
<span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;math/rand&quot;</span>
    <span class="s2">&quot;testing&quot;</span>
    <span class="s2">&quot;time&quot;</span>
<span class="p">)</span>
<span class="o">//</span> <span class="n">Implementations</span>
<span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">())</span>
<span class="p">}</span>
<span class="n">var</span> <span class="n">letterRunes</span> <span class="o">=</span> <span class="p">[]</span><span class="n">rune</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="p">)</span>
<span class="n">func</span> <span class="n">RandStringRunes</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">rune</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">b</span> <span class="p">{</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterRunes</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">letterRunes</span><span class="p">))]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">const</span> <span class="n">letterBytes</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
<span class="n">const</span> <span class="p">(</span>
    <span class="n">letterIdxBits</span> <span class="o">=</span> <span class="mi">6</span>                    <span class="o">//</span> <span class="mi">6</span> <span class="n">bits</span> <span class="n">to</span> <span class="n">represent</span> <span class="n">a</span> <span class="n">letter</span> <span class="n">index</span>
    <span class="n">letterIdxMask</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">letterIdxBits</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">//</span> <span class="n">All</span> <span class="mi">1</span><span class="o">-</span><span class="n">bits</span><span class="p">,</span> <span class="k">as</span> <span class="n">many</span> <span class="k">as</span> <span class="n">letterIdxBits</span>
    <span class="n">letterIdxMax</span>  <span class="o">=</span> <span class="mi">63</span> <span class="o">/</span> <span class="n">letterIdxBits</span>   <span class="o">//</span> <span class="c1"># of letter indices fitting in 63 bits</span>
<span class="p">)</span>
<span class="n">func</span> <span class="n">RandStringBytes</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">b</span> <span class="p">{</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterBytes</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">letterBytes</span><span class="p">))]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">RandStringBytesRmndr</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">b</span> <span class="p">{</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterBytes</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Int63</span><span class="p">()</span><span class="o">%</span><span class="n">int64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">letterBytes</span><span class="p">))]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">RandStringBytesMask</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="p">:</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Int63</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">letterIdxMask</span><span class="p">);</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">letterBytes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterBytes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">i</span><span class="o">++</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">RandStringBytesMaskImpr</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">rand</span><span class="o">.</span><span class="n">Int63</span><span class="p">()</span> <span class="n">generates</span> <span class="mi">63</span> <span class="n">random</span> <span class="n">bits</span><span class="p">,</span> <span class="n">enough</span> <span class="k">for</span> <span class="n">letterIdxMax</span> <span class="n">letters</span><span class="err">!</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">remain</span> <span class="p">:</span><span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rand</span><span class="o">.</span><span class="n">Int63</span><span class="p">(),</span> <span class="n">letterIdxMax</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">remain</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">cache</span><span class="p">,</span> <span class="n">remain</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">Int63</span><span class="p">(),</span> <span class="n">letterIdxMax</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="p">:</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache</span> <span class="o">&amp;</span> <span class="n">letterIdxMask</span><span class="p">);</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">letterBytes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterBytes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">i</span><span class="o">--</span>
        <span class="p">}</span>
        <span class="n">cache</span> <span class="o">&gt;&gt;=</span> <span class="n">letterIdxBits</span>
        <span class="n">remain</span><span class="o">--</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">var</span> <span class="n">src</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">NewSource</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">())</span>
<span class="n">func</span> <span class="n">RandStringBytesMaskImprSrc</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">src</span><span class="o">.</span><span class="n">Int63</span><span class="p">()</span> <span class="n">generates</span> <span class="mi">63</span> <span class="n">random</span> <span class="n">bits</span><span class="p">,</span> <span class="n">enough</span> <span class="k">for</span> <span class="n">letterIdxMax</span> <span class="n">characters</span><span class="err">!</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">remain</span> <span class="p">:</span><span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">Int63</span><span class="p">(),</span> <span class="n">letterIdxMax</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">remain</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">cache</span><span class="p">,</span> <span class="n">remain</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">Int63</span><span class="p">(),</span> <span class="n">letterIdxMax</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="p">:</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache</span> <span class="o">&amp;</span> <span class="n">letterIdxMask</span><span class="p">);</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">letterBytes</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterBytes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">i</span><span class="o">--</span>
        <span class="p">}</span>
        <span class="n">cache</span> <span class="o">&gt;&gt;=</span> <span class="n">letterIdxBits</span>
        <span class="n">remain</span><span class="o">--</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
<span class="o">//</span> <span class="n">Benchmark</span> <span class="n">functions</span>
<span class="n">const</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">func</span> <span class="n">BenchmarkRunes</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">RandStringRunes</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">BenchmarkBytes</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">RandStringBytes</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">BenchmarkBytesRmndr</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">RandStringBytesRmndr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">BenchmarkBytesMask</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">RandStringBytesMask</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">BenchmarkBytesMaskImpr</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">RandStringBytesMaskImpr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">BenchmarkBytesMaskImprSrc</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">RandStringBytesMaskImprSrc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3>其它提升</h3>
<p>其实如果能替换一个性能更好的随机数生成算法，可能性能会更好，我使用Xorshift算法实现了一个快速的随机数生成器， 和前面的实现做了比较，发觉性能会更好一点。</p>
<div class="highlight"><pre><span></span>BenchmarkRunes-4                         1000000              1396 ns/op
BenchmarkBytes-4                         2000000               799 ns/op
BenchmarkBytesRmndr-4                    3000000               627 ns/op
BenchmarkBytesMask-4                     2000000               719 ns/op
BenchmarkBytesMaskImpr-4                10000000               260 ns/op
BenchmarkBytesMaskImprSrc-4             10000000               227 ns/op
BenchmarkBytesMaskImprXorshiftSrc-4     10000000               205 ns/op
</pre></div>


<p>以上内容均引用自<a href="https://colobu.com/2018/09/02/generate-random-string-in-Go/">鸟窝的博客</a></p>
<h3>最后一种</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">(</span><span class="s2">&quot;math/rand&quot;</span><span class="p">)</span>

<span class="n">func</span> <span class="n">GetRandomString</span><span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">randBytes</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rand</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">randBytes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">randBytes</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://yull.in/tag/golang.html">golang</a>
      <a href="https://yull.in/tag/random-string.html">random string</a>
    </p>
  </div>




    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-7268840106840339"
         data-ad-slot="4525891349"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'yull-in';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    请启用浏览器的Javascript功能以查看评论。
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2019 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>本站由 <a href="http://getpelican.com" target="_blank">Pelican</a> 驱动，并使用了 <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a> 开发的 <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> 主题。</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Yullin's Blog ",
  "url" : "https://yull.in",
  "image": "https://yull.in/images/profile.png",
  "description": "Yullin's Thoughts and Writings"
}
</script>

</body>
</html>